---
import './LangSelector.scss'

interface Language {
  code: string
  name: string
  flag: string
}

interface Props {
  className?: string
  defaultLang?: 'ru' | 'en'
  mods?: string[]
}

const { className, defaultLang = 'en', mods } = Astro.props

const languages: Language[] = [
  { code: 'en', name: 'English', flag: 'ðŸ‡¬ðŸ‡§' },
  { code: 'ru', name: 'Ð ÑƒÑÑÐºÐ¸Ð¹', flag: 'ðŸ‡·ðŸ‡º' }
]

const currentLang = languages.find(lang => lang.code === defaultLang) || languages[0]
---

<div
  class:list={[
    'lang-selector',
    mods?.map((el: string) => `_${el}`),
    className
  ]}
  data-lang-selector
  data-default-lang={defaultLang}
>
  <button
    class="lang-selector__toggle"
    type="button"
    aria-expanded="false"
    aria-haspopup="listbox"
    data-lang-toggle
  >
    <span class="lang-selector__flag">{currentLang.flag}</span>
    <span class="lang-selector__code">{currentLang.code.toUpperCase()}</span>
    <svg class="lang-selector__arrow" width="12" height="12" viewBox="0 0 12 12" fill="none">
      <path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>

  <ul class="lang-selector__dropdown" role="listbox" data-lang-dropdown>
    {languages.map(lang => (
      <li
        class:list={[
          'lang-selector__option',
          { '_active': lang.code === defaultLang }
        ]}
        role="option"
        aria-selected={lang.code === defaultLang}
        data-lang-option={lang.code}
        data-lang-flag={lang.flag}
      >
        <span class="lang-selector__flag">{lang.flag}</span>
        <span class="lang-selector__name">{lang.name}</span>
      </li>
    ))}
  </ul>
</div>

<script>
  import { translations, locales, getNestedValue } from '@/i18n'
  import type { Locale } from '@/i18n'

  type TranslationsType = typeof translations

  const initLangSelector = (): void => {
    const selectors = document.querySelectorAll<HTMLElement>('[data-lang-selector]')
    
    // Get stored locale or default
    const storedLocale = localStorage.getItem('locale') as Locale | null
    const currentLocale: Locale = storedLocale && locales.includes(storedLocale) ? storedLocale : 'en'
    
    // Set initial html lang
    document.documentElement.lang = currentLocale

    // Translate function
    const t = (key: string, locale: Locale): string => {
      const translation = getNestedValue(translations[locale], key)
      return typeof translation === 'string' ? translation : key
    }

    // Translate all elements on page
    const translatePage = (locale: Locale): void => {
      // Translate text content
      document.querySelectorAll<HTMLElement>('[data-i18n]').forEach((el) => {
        const key = el.dataset.i18n
        if (key) el.textContent = t(key, locale)
      })

      // Translate alt text
      document.querySelectorAll<HTMLImageElement>('[data-i18n-alt]').forEach((el) => {
        const key = el.dataset.i18nAlt
        if (key) el.alt = t(key, locale)
      })
    }

    // Sync all selectors to show the same language
    const syncSelectors = (locale: Locale): void => {
      selectors.forEach(sel => {
        const toggle = sel.querySelector<HTMLButtonElement>('[data-lang-toggle]')
        const options = sel.querySelectorAll<HTMLElement>('[data-lang-option]')
        
        options.forEach(opt => {
          const isActive = opt.dataset.langOption === locale
          opt.classList.toggle('_active', isActive)
          opt.setAttribute('aria-selected', String(isActive))
          
          if (isActive && toggle) {
            const flag = opt.dataset.langFlag || ''
            const toggleFlag = toggle.querySelector('.lang-selector__flag')
            const toggleCode = toggle.querySelector('.lang-selector__code')
            if (toggleFlag) toggleFlag.textContent = flag
            if (toggleCode) toggleCode.textContent = locale.toUpperCase()
          }
        })
      })
    }

    // Initialize with stored locale
    syncSelectors(currentLocale)
    translatePage(currentLocale)

    selectors.forEach(selector => {
      const toggle = selector.querySelector<HTMLButtonElement>('[data-lang-toggle]')
      const dropdown = selector.querySelector<HTMLElement>('[data-lang-dropdown]')
      const options = selector.querySelectorAll<HTMLElement>('[data-lang-option]')

      if (!toggle || !dropdown) return

      const closeDropdown = (): void => {
        toggle.setAttribute('aria-expanded', 'false')
        selector.classList.remove('is-open')
      }

      const openDropdown = (): void => {
        toggle.setAttribute('aria-expanded', 'true')
        selector.classList.add('is-open')
      }

      toggle.addEventListener('click', (e) => {
        e.stopPropagation()
        const isOpen = toggle.getAttribute('aria-expanded') === 'true'
        if (isOpen) {
          closeDropdown()
        } else {
          openDropdown()
        }
      })

      options.forEach(option => {
        option.addEventListener('click', () => {
          const langCode = option.dataset.langOption as Locale
          if (!langCode || !locales.includes(langCode)) return

          // Save to localStorage
          localStorage.setItem('locale', langCode)
          document.documentElement.lang = langCode

          // Sync all selectors
          syncSelectors(langCode)

          // Translate the page
          translatePage(langCode)

          closeDropdown()
        })
      })

      // Close on outside click
      document.addEventListener('click', (e) => {
        const target = e.target as HTMLElement
        if (!selector.contains(target)) {
          closeDropdown()
        }
      })

      // Close on Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeDropdown()
        }
      })
    })
  }

  initLangSelector()
</script>
